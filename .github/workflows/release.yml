# ============================================================
# Release Workflow
# ============================================================
#
# 所需 GitHub Secrets：
#
# --- Tauri Updater 签名 ---
#   TAURI_SIGNING_PRIVATE_KEY          - Tauri 更新签名私钥（base64）
#   TAURI_SIGNING_PRIVATE_KEY_PASSWORD - 私钥密码
#
# --- macOS 代码签名 & 公证 ---
#   APPLE_CERTIFICATE          - Developer ID Application 证书（.p12 转 base64）
#   APPLE_CERTIFICATE_PASSWORD - .p12 导出密码
#   KEYCHAIN_PASSWORD          - CI 临时 keychain 密码（随意设一个强密码）
#   APPLE_ID                   - Apple Developer 账号邮箱
#   APPLE_PASSWORD             - App-Specific Password（在 appleid.apple.com 生成）
#   APPLE_TEAM_ID              - 开发者团队 ID（10 位）
#
# 重要经验：设置 TAURI_SIGNING_PRIVATE_KEY 等 Secrets 时，
# 必须使用 gh CLI 命令行设置，不要用 GitHub Web UI 粘贴！
#
# Web UI 会破坏 base64 密钥内容（截断、加换行），导致签名时报错：
#   - "Wrong password for that key"
#   - "Missing comment in secret key"
#   - "failed to fill whole buffer"
#
# 正确做法（在本地终端执行）：
#   Get-Content ".tauri/anyfast.key" -Raw | gh secret set TAURI_SIGNING_PRIVATE_KEY --repo owner/repo
#   echo "your-password" | gh secret set TAURI_SIGNING_PRIVATE_KEY_PASSWORD --repo owner/repo
#
#   macOS 证书设置：
#   openssl base64 -A -in certificate.p12 -out cert-base64.txt
#   cat cert-base64.txt | gh secret set APPLE_CERTIFICATE --repo owner/repo
# ============================================================

name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  # 先运行测试，确保代码质量
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Check formatting
        working-directory: rust/src-tauri
        run: cargo fmt --all -- --check

      - name: Run Clippy
        working-directory: rust/src-tauri
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Run Rust tests
        working-directory: rust/src-tauri
        run: cargo test --verbose

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: rust/package-lock.json

      - name: Install frontend dependencies
        working-directory: rust
        run: npm ci

      - name: TypeScript check
        working-directory: rust
        run: npx tsc --noEmit

      - name: Run frontend tests
        working-directory: rust
        run: npm test

  create-release:
    needs: test
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create-release.outputs.id }}
      release_upload_url: ${{ steps.create-release.outputs.upload_url }}
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Sync all version files from tag
        run: |
          TAG_VERSION=${GITHUB_REF#refs/tags/v}
          echo "Syncing all version files to $TAG_VERSION"

          # tauri.conf.json — Tauri 构建时读取的主版本号
          jq --arg v "$TAG_VERSION" '.version = $v' rust/src-tauri/tauri.conf.json > tmp.json && mv tmp.json rust/src-tauri/tauri.conf.json

          # Cargo.toml — Rust crate 版本号（仅替换 [package] 下的第一个 version）
          sed -i '0,/^version = ".*"/s/^version = ".*"/version = "'"$TAG_VERSION"'"/' rust/src-tauri/Cargo.toml

          # package.json — 前端版本号
          jq --arg v "$TAG_VERSION" '.version = $v' rust/package.json > tmp.json && mv tmp.json rust/package.json

          # README.md
          sed -i "s/# anyFAST v[0-9]*\.[0-9]*\.[0-9]*/# anyFAST v$TAG_VERSION/" README.md

          echo "✅ All versions synced to $TAG_VERSION"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add rust/src-tauri/tauri.conf.json rust/src-tauri/Cargo.toml rust/package.json README.md
          git diff --staged --quiet || git commit -m "chore: bump version to $TAG_VERSION"
          git push origin HEAD:main

      - name: Create Release
        id: create-release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          generate_release_notes: true

  build-release:
    needs: create-release
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            ext: .msi
            name: windows-x64
          - os: macos-latest
            target: x86_64-apple-darwin
            ext: .dmg
            name: macos-x64
          - os: macos-latest
            target: aarch64-apple-darwin
            ext: .dmg
            name: macos-arm64
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            ext: .deb
            name: linux-x64

    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Sync version from tag
        shell: bash
        run: |
          TAG_VERSION=${GITHUB_REF#refs/tags/v}
          echo "Syncing tauri.conf.json version to $TAG_VERSION"
          jq --arg v "$TAG_VERSION" '.version = $v' rust/src-tauri/tauri.conf.json > tmp.json && mv tmp.json rust/src-tauri/tauri.conf.json

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: rust/package-lock.json

      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            rust/src-tauri/target/
          key: ${{ runner.os }}-cargo-release-${{ matrix.target }}-${{ hashFiles('rust/src-tauri/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-release-${{ matrix.target }}-
            ${{ runner.os }}-cargo-

      - name: Install frontend dependencies
        working-directory: rust
        run: npm ci

      - name: Check macOS signing secrets
        if: matrix.os == 'macos-latest'
        id: macos_signing
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          if [ -n "$APPLE_CERTIFICATE" ] && [ -n "$APPLE_CERTIFICATE_PASSWORD" ] && [ -n "$KEYCHAIN_PASSWORD" ]; then
            echo "enabled=true" >> "$GITHUB_OUTPUT"
            echo "macOS code signing enabled."
          else
            echo "enabled=false" >> "$GITHUB_OUTPUT"
            echo "::warning::macOS signing secrets are missing. Building unsigned macOS artifacts."
          fi

      # ---- macOS 代码签名：导入 Apple Developer 证书 ----
      - name: Import Apple Developer Certificate (macOS only)
        if: matrix.os == 'macos-latest' && steps.macos_signing.outputs.enabled == 'true'
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          # 将 base64 编码的证书解码为 .p12 文件
          echo "$APPLE_CERTIFICATE" | base64 --decode > certificate.p12

          # 创建临时 keychain 并导入证书
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain
          security import certificate.p12 -k build.keychain \
            -P "$APPLE_CERTIFICATE_PASSWORD" \
            -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: \
            -s -k "$KEYCHAIN_PASSWORD" build.keychain

          # 验证证书已正确导入并提取签名身份
          IDENTITY=$(security find-identity -v -p codesigning build.keychain | head -1 | awk -F'"' '{print $2}')
          echo "Found signing identity: $IDENTITY"
          echo "APPLE_SIGNING_IDENTITY=$IDENTITY" >> $GITHUB_ENV

          # 清理 .p12 文件
          rm -f certificate.p12

      - name: Build Windows Service (Windows only)
        if: matrix.os == 'windows-latest'
        working-directory: rust/src-tauri
        shell: pwsh
        run: |
          cargo build --release --bin anyfast-service
          New-Item -ItemType Directory -Path binaries -Force | Out-Null
          Copy-Item target/release/anyfast-service.exe binaries/anyfast-service-x86_64-pc-windows-msvc.exe

      - name: Configure Windows resources (Windows only)
        if: matrix.os == 'windows-latest'
        working-directory: rust/src-tauri
        shell: pwsh
        run: |
          $config = Get-Content tauri.conf.json | ConvertFrom-Json
          $config.bundle | Add-Member -NotePropertyName "resources" -NotePropertyValue @{"binaries/anyfast-service-x86_64-pc-windows-msvc.exe" = "anyfast-service.exe"} -Force
          $config | ConvertTo-Json -Depth 10 | Set-Content tauri.conf.json

      - name: Build macOS Helper (macOS only)
        if: matrix.os == 'macos-latest'
        working-directory: rust/src-tauri
        run: |
          cargo build --release --target ${{ matrix.target }} --bin anyfast-helper-macos
          mkdir -p binaries
          cp target/${{ matrix.target }}/release/anyfast-helper-macos binaries/anyfast-helper-macos-${{ matrix.target }}

      - name: Configure macOS externalBin (macOS only)
        if: matrix.os == 'macos-latest'
        working-directory: rust/src-tauri
        run: |
          # Add externalBin to tauri.conf.json for macOS builds
          jq '.bundle.externalBin = ["binaries/anyfast-helper-macos"]' tauri.conf.json > tauri.conf.json.tmp
          mv tauri.conf.json.tmp tauri.conf.json

      - name: Clean old bundles
        shell: bash
        run: rm -rf rust/src-tauri/target/${{ matrix.target }}/release/bundle

      - name: Build Tauri app
        working-directory: rust
        env:
          # Tauri updater 签名密钥
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          # macOS 代码签名（APPLE_SIGNING_IDENTITY 由上面的证书导入步骤设置）
          # macOS 公证（Notarization）—— 需要 Apple Developer 账号
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: npm run tauri build -- --target ${{ matrix.target }}

      - name: Upload Windows artifacts
        if: matrix.os == 'windows-latest'
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          files: |
            rust/src-tauri/target/${{ matrix.target }}/release/bundle/msi/*.msi
            rust/src-tauri/target/${{ matrix.target }}/release/bundle/nsis/*.exe
            rust/src-tauri/target/${{ matrix.target }}/release/bundle/nsis/*.nsis.zip
            rust/src-tauri/target/${{ matrix.target }}/release/bundle/nsis/*.nsis.zip.sig

      - name: Upload macOS DMG and Helper
        if: matrix.os == 'macos-latest'
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          files: |
            rust/src-tauri/target/${{ matrix.target }}/release/bundle/dmg/*.dmg
            rust/src-tauri/target/${{ matrix.target }}/release/anyfast-helper-macos

      # ---- macOS: 清理临时 keychain ----
      - name: Cleanup macOS keychain (macOS only)
        if: matrix.os == 'macos-latest' && always()
        run: security delete-keychain build.keychain || true

      - name: Upload Linux packages
        if: matrix.os == 'ubuntu-latest'
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          files: |
            rust/src-tauri/target/${{ matrix.target }}/release/bundle/deb/*.deb
            rust/src-tauri/target/${{ matrix.target }}/release/bundle/appimage/*.AppImage

  publish-release:
    needs: [create-release, build-release]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install minisign
        run: |
          sudo apt-get update
          sudo apt-get install -y minisign

      - name: Generate latest.json for updater
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          RELEASE_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # Download Windows updater artifacts from the release
          mkdir -p sigs
          gh release download "v${VERSION}" \
            --repo "${{ github.repository }}" \
            --pattern "*.nsis.zip.sig" \
            --dir sigs/
          gh release download "v${VERSION}" \
            --repo "${{ github.repository }}" \
            --pattern "*.nsis.zip" \
            --dir sigs/

          WIN_SIG_FILE=$(ls sigs/*.nsis.zip.sig | head -n1)
          WIN_ZIP_FILE=$(ls sigs/*.nsis.zip | head -n1)
          WIN_ZIP_NAME=$(basename "$WIN_ZIP_FILE")

          # 验证签名和公钥一致性，避免发布后应用内更新失败
          PUBKEY_B64=$(jq -r '.plugins.updater.pubkey' rust/src-tauri/tauri.conf.json)
          echo "$PUBKEY_B64" | base64 --decode > updater.pub
          base64 --decode "$WIN_SIG_FILE" > windows.sig.decoded
          minisign -Vm "$WIN_ZIP_FILE" -x windows.sig.decoded -p updater.pub

          # signature 使用 .sig 文件原始内容（base64 文本）
          WIN_SIG=$(tr -d '\r\n' < "$WIN_SIG_FILE")
          WIN_URL="https://github.com/${{ github.repository }}/releases/download/v${VERSION}/${WIN_ZIP_NAME}"

          # Generate latest.json with proper updater format
          jq -n \
            --arg version "$VERSION" \
            --arg notes "Release v$VERSION" \
            --arg pub_date "$RELEASE_DATE" \
            --arg win_sig "$WIN_SIG" \
            --arg win_url "$WIN_URL" \
            '{
              version: $version,
              notes: $notes,
              pub_date: $pub_date,
              platforms: {
                "windows-x86_64": {
                  signature: $win_sig,
                  url: $win_url
                },
                "windows-x86_64-nsis": {
                  signature: $win_sig,
                  url: $win_url
                },
                "windows-x86_64-msi": {
                  signature: $win_sig,
                  url: $win_url
                }
              }
            }' > latest.json

      - name: Generate latest-cn.json for Chinese users (proxy download URLs)
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          # Re-read variables from latest.json
          WIN_SIG=$(jq -r '.platforms."windows-x86_64".signature' latest.json)
          WIN_URL_RAW=$(jq -r '.platforms."windows-x86_64".url' latest.json)
          RELEASE_DATE=$(jq -r '.pub_date' latest.json)

          # Prefix download URL with ghproxy.net proxy
          WIN_URL_CN="https://ghproxy.net/${WIN_URL_RAW}"

          jq -n \
            --arg version "$VERSION" \
            --arg notes "Release v$VERSION" \
            --arg pub_date "$RELEASE_DATE" \
            --arg win_sig "$WIN_SIG" \
            --arg win_url "$WIN_URL_CN" \
            '{
              version: $version,
              notes: $notes,
              pub_date: $pub_date,
              platforms: {
                "windows-x86_64": {
                  signature: $win_sig,
                  url: $win_url
                },
                "windows-x86_64-nsis": {
                  signature: $win_sig,
                  url: $win_url
                },
                "windows-x86_64-msi": {
                  signature: $win_sig,
                  url: $win_url
                }
              }
            }' > latest-cn.json

      - name: Upload latest.json and latest-cn.json
        uses: softprops/action-gh-release@v2
        with:
          files: |
            latest.json
            latest-cn.json
      
      - name: Publish Release
        uses: softprops/action-gh-release@v2
        with:
          draft: false
